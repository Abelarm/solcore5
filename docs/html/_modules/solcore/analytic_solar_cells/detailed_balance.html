
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>solcore.analytic_solar_cells.detailed_balance &#8212; Solcore 5.3.0.dev.1 documentation</title>
    <link rel="stylesheet" href="../../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '5.3.0.dev.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head>
  <body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">Solcore 5.3.0.dev.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/header2.png" alt="Logo"/>
            </a></p>
<h3><a href="../../../index.html">Table Of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../Installation/installation.html">Installation and configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Structures/structure.html">Structures and support classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Systems/systems.html">Materials and units</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../QM/Schrodinger.html">Quantum Solvers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../spectral/spectral.html">Light Sources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Optics/optics.html">Optical methods</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Solvers/solving_solar_cells.html">Solar cell solvers</a></li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for solcore.analytic_solar_cells.detailed_balance</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="k">import</span> <span class="n">interp1d</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">solcore.constants</span> <span class="k">import</span> <span class="n">kb</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">h</span>
<span class="kn">from</span> <span class="nn">solcore</span> <span class="k">import</span> <span class="n">si</span>
<span class="kn">from</span> <span class="nn">solcore.state</span> <span class="k">import</span> <span class="n">State</span>

<span class="n">db_options</span> <span class="o">=</span> <span class="n">State</span><span class="p">()</span>
<span class="n">db_options</span><span class="o">.</span><span class="n">db_mode</span> <span class="o">=</span> <span class="s1">&#39;boltzmann&#39;</span>


<div class="viewcode-block" id="iv_detailed_balance"><a class="viewcode-back" href="../../../Solvers/detailed_balance.html#solcore.analytic_solar_cells.detailed_balance.iv_detailed_balance">[docs]</a><span class="k">def</span> <span class="nf">iv_detailed_balance</span><span class="p">(</span><span class="n">junction</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Calculates the IV curve of a junction of kind &quot;DB&quot;. This is a detailed balanced calculation of the IV curve of a PN junction characterized by a certain eqe, temperature and chemical potential (voltage). Normally, the eqe will be calculated based on a a given absorption edge and absorptance level resulting in a &quot;top hat&quot; type of eqe, but it can also be provided externally. By default, the solver uses the Boltzmann aproximation, although the full Planck equation might be used, also.</span>

<span class="sd">    :param junction: A Junction object of kind &quot;DB&quot;</span>
<span class="sd">    :param options: Other arguments for the calculation of the IV.</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">T</span>
    <span class="n">light</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">light_iv</span>
    <span class="n">mode</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">db_mode</span>
    <span class="n">Ta</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">T_ambient</span>
    <span class="n">wl</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">wavelength</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">Eg</span> <span class="o">=</span> <span class="n">junction</span><span class="o">.</span><span class="n">Eg</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">junction</span><span class="o">.</span><span class="n">n</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">junction</span><span class="p">,</span> <span class="s1">&#39;eqe&#39;</span><span class="p">):</span>
            <span class="n">qe_detailed_balance</span><span class="p">(</span><span class="n">junction</span><span class="p">,</span> <span class="n">wl</span><span class="p">)</span>

        <span class="n">eqe</span> <span class="o">=</span> <span class="n">junction</span><span class="o">.</span><span class="n">eqe</span>
        <span class="n">As</span> <span class="o">=</span> <span class="n">surface_integral</span><span class="p">(</span><span class="n">junction</span><span class="p">,</span> <span class="n">wl</span><span class="p">)</span>

        <span class="n">R_shunt</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">junction</span><span class="o">.</span><span class="n">R_shunt</span><span class="p">,</span> <span class="mf">1e14</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">junction</span><span class="p">,</span> <span class="s1">&#39;R_shunt&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="mf">1e14</span>

    <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
            <span class="s1">&#39;ERROR calculating the IV for the detailed balance Junction kind. Junction is missing one essential argument: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">err</span><span class="p">))</span>

    <span class="n">j01</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> <span class="n">n</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">c</span>
    <span class="c1"># We loop over the (internal) voltages to get the (internal) current. The actual voltage applied is always smaller than Eg.</span>
    <span class="n">junction</span><span class="o">.</span><span class="n">voltage</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">internal_voltages</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;boltzmann&#39;</span><span class="p">:</span>
        <span class="c1"># If Boltzmann, the calculation can be vectorized as the voltages is outside the integral. No limit to V</span>
        <span class="n">volt</span> <span class="o">=</span> <span class="n">junction</span><span class="o">.</span><span class="n">voltage</span>

        <span class="k">def</span> <span class="nf">emis</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">T</span><span class="p">):</span>
            <span class="n">boltz</span> <span class="o">=</span> <span class="n">j01</span> <span class="o">*</span> <span class="p">(</span><span class="n">As</span> <span class="o">/</span> <span class="n">wl</span> <span class="o">**</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span> <span class="p">(</span><span class="n">h</span> <span class="o">*</span> <span class="n">c</span> <span class="o">/</span> <span class="n">wl</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">kb</span> <span class="o">*</span> <span class="n">T</span><span class="p">))</span>
            <span class="n">junction</span><span class="o">.</span><span class="n">j01</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">boltz</span><span class="p">,</span> <span class="n">wl</span><span class="p">)</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">boltz</span><span class="p">,</span> <span class="n">wl</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="n">q</span> <span class="o">*</span> <span class="n">v</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">kb</span> <span class="o">*</span> <span class="n">T</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">out</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># If the full Planck equation is used, we need to loop over the voltages. We limit them to the bandgap</span>
        <span class="n">volt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">junction</span><span class="o">.</span><span class="n">voltage</span> <span class="o">&lt;</span> <span class="n">Eg</span> <span class="o">-</span> <span class="mf">0.001</span><span class="p">,</span> <span class="n">junction</span><span class="o">.</span><span class="n">voltage</span><span class="p">,</span> <span class="n">Eg</span> <span class="o">-</span> <span class="mf">0.001</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">emis</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">T</span><span class="p">):</span>
            <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                <span class="n">fermi</span> <span class="o">=</span> <span class="p">(</span><span class="n">As</span> <span class="o">/</span> <span class="n">wl</span> <span class="o">**</span> <span class="mi">4</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="n">h</span> <span class="o">*</span> <span class="n">c</span> <span class="o">/</span> <span class="n">wl</span> <span class="o">-</span> <span class="n">q</span> <span class="o">*</span> <span class="n">vv</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">kb</span> <span class="o">*</span> <span class="n">T</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">fermi</span><span class="p">,</span> <span class="n">wl</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">j01</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

    <span class="c1"># Now we calculate the generation current, made of thermal generation and photogeneration</span>
    <span class="n">jthermal</span> <span class="o">=</span> <span class="n">emis</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">]),</span> <span class="n">Ta</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">light</span><span class="p">:</span>
        <span class="n">wl</span><span class="p">,</span> <span class="n">ph</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">light_source</span><span class="o">.</span><span class="n">spectrum</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">wl</span><span class="p">,</span> <span class="n">output_units</span><span class="o">=</span><span class="s1">&#39;photon_flux_per_m&#39;</span><span class="p">)</span>
        <span class="n">jsc</span> <span class="o">=</span> <span class="n">q</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">eqe</span><span class="p">(</span><span class="n">wl</span><span class="p">)</span> <span class="o">*</span> <span class="n">ph</span><span class="p">,</span> <span class="n">wl</span><span class="p">)</span> <span class="o">+</span> <span class="n">jthermal</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">jsc</span> <span class="o">=</span> <span class="n">jthermal</span>

    <span class="n">junction</span><span class="o">.</span><span class="n">current</span> <span class="o">=</span> <span class="n">emis</span><span class="p">(</span><span class="n">volt</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="n">volt</span> <span class="o">/</span> <span class="n">R_shunt</span> <span class="o">-</span> <span class="n">jsc</span>

    <span class="n">junction</span><span class="o">.</span><span class="n">iv</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">junction</span><span class="o">.</span><span class="n">voltage</span><span class="p">,</span> <span class="n">junction</span><span class="o">.</span><span class="n">current</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">assume_sorted</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                           <span class="n">fill_value</span><span class="o">=</span><span class="p">(</span><span class="n">junction</span><span class="o">.</span><span class="n">current</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">junction</span><span class="o">.</span><span class="n">current</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span></div>


<div class="viewcode-block" id="qe_detailed_balance"><a class="viewcode-back" href="../../../Solvers/detailed_balance.html#solcore.analytic_solar_cells.detailed_balance.qe_detailed_balance">[docs]</a><span class="k">def</span> <span class="nf">qe_detailed_balance</span><span class="p">(</span><span class="n">junction</span><span class="p">,</span> <span class="n">wl</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Calculates the EQE and the IQE in the detailed balanced limit... which is equal to the absorptance and the absorbed fraction of the light since, by definition of detailed balanced, the carrier collection is perfect.</span>

<span class="sd">    :param junction: Junction object of kind &quot;DB&quot;</span>
<span class="sd">    :param wl: wavelength in m</span>
<span class="sd">    :return: None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">absorptance_detailed_balance</span><span class="p">(</span><span class="n">junction</span><span class="p">)</span>

    <span class="c1"># This is true just in the detailed balance limit</span>
    <span class="n">junction</span><span class="o">.</span><span class="n">iqe</span> <span class="o">=</span> <span class="n">junction</span><span class="o">.</span><span class="n">absorptance</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">junction</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="mi">1001</span><span class="p">)</span>
        <span class="n">all_abs</span> <span class="o">=</span> <span class="n">junction</span><span class="o">.</span><span class="n">absorbed</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
        <span class="n">abs_vs_wl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">all_abs</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">junction</span><span class="o">.</span><span class="n">eqe</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">abs_vs_wl</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="n">junction</span><span class="o">.</span><span class="n">eqe</span> <span class="o">=</span> <span class="n">junction</span><span class="o">.</span><span class="n">absorptance</span></div>


<div class="viewcode-block" id="absorptance_detailed_balance"><a class="viewcode-back" href="../../../Solvers/detailed_balance.html#solcore.analytic_solar_cells.detailed_balance.absorptance_detailed_balance">[docs]</a><span class="k">def</span> <span class="nf">absorptance_detailed_balance</span><span class="p">(</span><span class="n">junction</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Calculates the absorptance of the junction in the detailed balanced case. If it has not been calculated before, provided as input, it uses a &quot;top hat&quot; absorptance with the absorption edge at Eg and magnitude A.</span>

<span class="sd">    Note that while the junction.absorptance represents the potential fraction of light that can be absorbed at a given energy, the junction.absorbed represents the actual fraction of input light that is absorbed. For detailed balanced calculations, these two are equivalent to the IQE and EQE respectively because carrier collection is perfect, but that will not be the case, in general.</span>

<span class="sd">    :param junction: Junction object of kind &quot;DB&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">junction</span><span class="p">,</span> <span class="s1">&#39;absorptance&#39;</span><span class="p">):</span>
            <span class="n">wlg</span> <span class="o">=</span> <span class="n">si</span><span class="p">(</span><span class="mi">1240</span> <span class="o">/</span> <span class="n">junction</span><span class="o">.</span><span class="n">Eg</span><span class="p">,</span> <span class="s1">&#39;nm&#39;</span><span class="p">)</span>
            <span class="n">A</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">junction</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">absorptance</span><span class="p">(</span><span class="n">wl</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">A</span> <span class="o">*</span> <span class="p">(</span><span class="n">wl</span> <span class="o">&lt;</span> <span class="n">wlg</span><span class="p">)</span>

            <span class="n">junction</span><span class="o">.</span><span class="n">absorptance</span> <span class="o">=</span> <span class="n">absorptance</span>

    <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
            <span class="s1">&#39;ERROR calculating absorptance for the detailed balance Junction kind.</span><span class="se">\n</span><span class="s1">Junction is missing one essential argument: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">err</span><span class="p">))</span></div>


<div class="viewcode-block" id="surface_integral"><a class="viewcode-back" href="../../../Solvers/detailed_balance.html#solcore.analytic_solar_cells.detailed_balance.surface_integral">[docs]</a><span class="k">def</span> <span class="nf">surface_integral</span><span class="p">(</span><span class="n">junction</span><span class="p">,</span> <span class="n">wl</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Calculates the surface integral of the absorptivity</span>

<span class="sd">    :param junction:</span>
<span class="sd">    :param options:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Rn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="mf">0.999999</span><span class="p">,</span> <span class="n">junction</span><span class="o">.</span><span class="n">reflected</span><span class="p">(</span><span class="n">wl</span><span class="p">))</span>

    <span class="c1"># Out of the normal incidence reflection we calculate an effective refractive index</span>
    <span class="n">neff</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Rn</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Rn</span><span class="p">))</span>

    <span class="c1"># And the corresponding critical angle</span>
    <span class="n">cos_tc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">neff</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">steps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="mi">20</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">cos_tc</span><span class="p">))))</span>
    <span class="n">cos_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">steps</span><span class="p">)</span>

    <span class="c1"># And now, we back calculate the reflection at any internal angle</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">wl</span><span class="p">),</span> <span class="n">steps</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wl</span><span class="p">)):</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cos_t</span> <span class="o">&gt;</span> <span class="n">cos_tc</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="n">Rs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">steps</span><span class="p">)</span>
        <span class="n">Rp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">steps</span><span class="p">)</span>

        <span class="n">cos_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">neff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">cos_t</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>

        <span class="n">Rs</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">cos_i</span> <span class="o">-</span> <span class="n">neff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">cos_t</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">cos_i</span> <span class="o">+</span> <span class="n">neff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">cos_t</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">Rp</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">cos_t</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">-</span> <span class="n">neff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">cos_i</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">cos_t</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="n">neff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">cos_i</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span>

        <span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Rs</span> <span class="o">+</span> <span class="n">Rp</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="c1"># B = exp(-alpha*w) but it is not necessary to calculate alpha and w explicitly</span>
    <span class="n">B</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">junction</span><span class="o">.</span><span class="n">absorptance</span><span class="p">(</span><span class="n">wl</span><span class="p">)</span>
    <span class="n">A_back</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">R</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">B</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">B</span><span class="p">)</span>
    <span class="n">A_front</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">R</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">B</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">steps</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">cos_t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># The integral of the absorpton/emission across the back surface</span>
        <span class="n">A_back</span> <span class="o">=</span> <span class="n">A_back</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">R</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">B</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">t</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">B</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">t</span><span class="p">))</span> <span class="o">*</span> <span class="n">t</span>

        <span class="c1"># The integral of the absorpton/emission across the front surface</span>
        <span class="n">A_front</span> <span class="o">=</span> <span class="n">A_front</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">R</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">B</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">t</span><span class="p">))</span> <span class="o">*</span> <span class="n">t</span>

    <span class="n">A_back</span> <span class="o">=</span> <span class="n">A_back</span> <span class="o">/</span> <span class="p">(</span><span class="n">steps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">A_front</span> <span class="o">=</span> <span class="n">A_front</span> <span class="o">/</span> <span class="p">(</span><span class="n">steps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">A_back</span> <span class="o">+</span> <span class="n">A_front</span><span class="p">)</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

    <span class="kn">from</span> <span class="nn">solcore.state</span> <span class="k">import</span> <span class="n">State</span>
    <span class="kn">from</span> <span class="nn">solcore</span> <span class="k">import</span> <span class="n">material</span>

    <span class="n">junction</span> <span class="o">=</span> <span class="n">State</span><span class="p">()</span>
    <span class="n">options</span> <span class="o">=</span> <span class="n">State</span><span class="p">()</span>

    <span class="n">wl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">300</span><span class="p">,</span> <span class="mi">900</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-9</span>
    <span class="n">GaAs</span> <span class="o">=</span> <span class="n">material</span><span class="p">(</span><span class="s1">&#39;GaAs&#39;</span><span class="p">)(</span><span class="n">T</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>

    <span class="n">n</span> <span class="o">=</span> <span class="n">GaAs</span><span class="o">.</span><span class="n">n</span><span class="p">(</span><span class="n">wl</span><span class="p">)</span>
    <span class="n">cos_tc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">n</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">Rn</span> <span class="o">=</span> <span class="p">((</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">wlg</span> <span class="o">=</span> <span class="mi">800</span> <span class="o">*</span> <span class="mf">1e-9</span>
    <span class="n">A</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">V</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">T</span> <span class="o">=</span> <span class="mi">300</span>

    <span class="n">options</span><span class="o">.</span><span class="n">wavelength</span> <span class="o">=</span> <span class="n">wl</span>
    <span class="n">junction</span><span class="o">.</span><span class="n">reflected</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">Rn</span><span class="p">)</span>
    <span class="n">junction</span><span class="o">.</span><span class="n">absorptance</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">A</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">wlg</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="n">As</span> <span class="o">=</span> <span class="n">surface_integral</span><span class="p">(</span><span class="n">junction</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>

    <span class="n">jE</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> <span class="n">n</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">c</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">wl</span> <span class="o">**</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="n">As</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="n">h</span> <span class="o">*</span> <span class="n">c</span> <span class="o">/</span> <span class="n">wl</span> <span class="o">-</span> <span class="n">q</span> <span class="o">*</span> <span class="n">V</span><span class="p">)</span> <span class="o">/</span> <span class="n">kb</span> <span class="o">/</span> <span class="n">T</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">jE</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


    <span class="c1">#</span>
    <span class="c1"># all_cos_t = np.linspace(min(cos_tc), 1, 10)</span>
    <span class="c1"># Rs = np.zeros_like(n)</span>
    <span class="c1"># Rp = np.zeros_like(n)</span>
    <span class="c1"># Rnew = np.zeros_like(n)</span>
    <span class="c1"># for cos_t in all_cos_t:</span>
    <span class="c1">#     for i in range(len(wl)):</span>
    <span class="c1">#         if (cos_t &gt; cos_tc[i]):</span>
    <span class="c1">#             cos_i = np.sqrt(1 - n[i] ** 2 * (1 - cos_t ** 2))</span>
    <span class="c1">#             Rs[i] = ((cos_i - n[i] * cos_t) / (cos_i + n[i] * cos_t)) ** 2</span>
    <span class="c1">#             Rp[i] = ((cos_t - n[i] * cos_i) / (cos_t + n[i] * cos_i)) ** 2</span>
    <span class="c1">#         else:</span>
    <span class="c1">#             Rs[i] = 1</span>
    <span class="c1">#             Rp[i] = 1</span>
    <span class="c1">#</span>
    <span class="c1">#         Rnew[i] = myR(wl[i], cos_t)</span>
    <span class="c1">#</span>
    <span class="c1">#     plt.plot(wl, (Rs + Rp) / 2, &#39;o&#39;)</span>
    <span class="c1">#     plt.plot(wl, Rnew, &#39;k&#39;)</span>
    <span class="c1">#</span>
    <span class="c1"># plt.show()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">Solcore 5.3.0.dev.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2018, Quantum Photovoltaics Group, Imperial College London.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.6.
    </div>
  </body>
</html>