
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>solcore.poisson_drift_diffusion.QWunit &#8212; Solcore 5.0.2 documentation</title>
    <link rel="stylesheet" href="../../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '5.0.2',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head>
  <body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">Solcore 5.0.2 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/header2.png" alt="Logo"/>
            </a></p>
<h3><a href="../../../index.html">Table Of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation and configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../structure.html">Structures and support classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Systems/Units.html">The Units System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Systems/Parameters.html">The Parameters System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Systems/Materials.html">The Materials System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Systems/Mobility.html">The mobility module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../QM/Schrodinger.html">1D arbitrary potential Schrödinger and k•p band structure solvers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Absorption/Absorption.html">Absorption calculator</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../spectral/spectral.html">Light Sources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ASC/ASC.html">Analytic solar cells calculator</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../PDD/DDsolver.html">Poisson - Drift-Diffusion solver (PDD)</a></li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for solcore.poisson_drift_diffusion.QWunit</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.special</span> <span class="k">import</span> <span class="n">erfc</span>
<span class="kn">from</span> <span class="nn">solcore</span> <span class="k">import</span> <span class="n">constants</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">si</span>
<span class="kn">from</span> <span class="nn">solcore.structure</span> <span class="k">import</span> <span class="n">Layer</span><span class="p">,</span> <span class="n">Structure</span>
<span class="kn">from</span> <span class="nn">solcore.quantum_mechanics</span> <span class="k">import</span> <span class="n">schrodinger</span>
<span class="kn">from</span> <span class="nn">solcore.quantum_mechanics.kp_bulk</span> <span class="k">import</span> <span class="n">kp8x8_bulk</span>
<span class="kn">from</span> <span class="nn">solcore.quantum_mechanics.strain</span> <span class="k">import</span> <span class="n">strain_calculation_parameters</span>
<span class="kn">from</span> <span class="nn">solcore.absorption_calculator</span> <span class="k">import</span> <span class="n">adachi_alpha</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">q</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">q</span>
<span class="n">pi</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">pi</span>
<span class="n">h</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">h</span>
<span class="n">kb</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">kb</span>
<span class="n">m0</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">electron_mass</span>
<span class="n">vacuum_permittivity</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">vacuum_permittivity</span>


<div class="viewcode-block" id="QWunit"><a class="viewcode-back" href="../../../PDD/QWunit.html#solcore.poisson_drift_diffusion.QWunit.QWunit">[docs]</a><span class="k">class</span> <span class="nc">QWunit</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Asembles a group of layers as a quantum well, calculating its properties as a whole</span>
<span class="sd">    </span>
<span class="sd">    - It needs a minimum of 3 layers</span>
<span class="sd">    - There must be exactly one layer with the role = &quot;well&quot;.</span>
<span class="sd">    - Top and bottom layers are assumed to be the barriers.</span>
<span class="sd">    - Anything not a barrier not a well will be considered as &quot;interlayer&quot;.    </span>
<span class="sd">    </span>
<span class="sd">    Since the Poisson - Drift-Diffusion solver can not work with superlatices, there is no point of considering the solution of more than one QW. </span>
<span class="sd">    All QWs entering into the solver are independent, regardless of the width of the barriers.</span>
<span class="sd">    </span>
<span class="sd">    To account for the possible presence of nearby QWs, perdiodic boundary conditions can be used to solve the Schrodinger equation. </span>
<span class="sd">    If barriers + interlayers are thick enought, this make no difference but if they are thin, it affects the number of confined levels. </span>
<span class="sd">    It does not &#39;create&#39; minibands, though, so the results with thin barriers must be used with caution.  </span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Initialises the QWunit, checking that it has all the necessary layers &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ERROR creating a QWunit: a minimum of 3 layers is necesarry to make a unit. Only </span><span class="si">{0}</span><span class="s2"> found. &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)))</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">QW_number</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">QW_width</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s2">&quot;role&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;barrier&quot;</span>
        <span class="bp">self</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s2">&quot;role&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;barrier&quot;</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">layer</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">role</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;well&quot;</span><span class="p">,</span> <span class="s2">&quot;qw&quot;</span><span class="p">,</span> <span class="s2">&quot;QW&quot;</span><span class="p">,</span> <span class="s2">&quot;Qw&quot;</span><span class="p">,</span> <span class="s2">&quot;Well&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">QW_number</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">QW_width</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">width</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">role</span> <span class="o">=</span> <span class="s2">&quot;well&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s2">&quot;role&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;interlayer&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">QW_number</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ERROR creating a QWunit: There must be exactly one layer with the role = &#39;well&#39;. </span><span class="si">{0}</span><span class="s2"> found. &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">QW_number</span><span class="p">))</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

        <span class="k">if</span> <span class="s1">&#39;substrate&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ERROR creating a QWunit: There must be a substrate defined with the keyword &#39;substrate&#39;. &quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

        <span class="c1"># We update the structure of labels since that is what the quantum mechanics modules uses to identify the regions, not the role. </span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">role</span>

    <span class="c1"># ------</span>
<div class="viewcode-block" id="QWunit.RecalculateKP"><a class="viewcode-back" href="../../../PDD/QWunit.html#solcore.poisson_drift_diffusion.QWunit.QWunit.RecalculateKP">[docs]</a>    <span class="k">def</span> <span class="nf">RecalculateKP</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Recalculates the band structure of the QW unit to account for modifications due to strain. </span>
<span class="sd">        </span>
<span class="sd">        This is already done in the Schrodinger solver, but it does not produce that information as output. We do it so here.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;kp8x8_bulk&#39;</span><span class="p">:</span>
            <span class="n">kp_result</span> <span class="o">=</span> <span class="n">kp8x8_bulk</span><span class="p">(</span><span class="n">material</span><span class="o">=</span><span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">material</span><span class="p">,</span> <span class="n">host_material</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">substrate</span><span class="p">,</span> <span class="n">averaging_points</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
            <span class="n">c</span><span class="p">,</span> <span class="n">hh</span><span class="p">,</span> <span class="n">lh</span><span class="p">,</span> <span class="n">so</span><span class="p">,</span> <span class="n">me</span><span class="p">,</span> <span class="n">mhh</span><span class="p">,</span> <span class="n">mlh</span><span class="p">,</span> <span class="n">mso</span> <span class="o">=</span> <span class="n">kp_result</span>

            <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">eff_mass_electron_Gamma</span> <span class="o">=</span> <span class="n">me</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">eff_mass_hh_z</span> <span class="o">=</span> <span class="n">mhh</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">eff_mass_lh_z</span> <span class="o">=</span> <span class="n">mlh</span>

            <span class="c1"># We recalculate the bandgap adn the electron afinity</span>
            <span class="n">Ec</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">valence_band_offset</span> <span class="o">+</span> <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">band_gap</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">band_gap</span> <span class="o">=</span> <span class="n">c</span> <span class="o">-</span> <span class="nb">max</span><span class="p">(</span><span class="n">hh</span><span class="p">,</span> <span class="n">lh</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">electron_affinity</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">electron_affinity</span> <span class="o">-</span> <span class="n">c</span> <span class="o">+</span> <span class="n">Ec</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">me</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">eff_mass_electron_Gamma</span> <span class="o">*</span> <span class="n">m0</span>
            <span class="n">mhh</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">eff_mass_hh_z</span> <span class="o">*</span> <span class="n">m0</span>
            <span class="n">mlh</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">eff_mass_lh_z</span> <span class="o">*</span> <span class="n">m0</span>

            <span class="c1"># Idem</span>
            <span class="n">strain_parameters</span> <span class="o">=</span> <span class="n">strain_calculation_parameters</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">substrate</span><span class="p">,</span> <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">material</span><span class="p">,</span> <span class="n">should_print</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">electron_affinity</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">electron_affinity</span> <span class="o">-</span> <span class="n">strain_parameters</span><span class="o">.</span><span class="n">delta_Ec</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">band_gap</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">band_gap</span> <span class="o">+</span> <span class="n">strain_parameters</span><span class="o">.</span><span class="n">delta_Ec</span> <span class="o">+</span> <span class="nb">max</span><span class="p">(</span>
                <span class="n">strain_parameters</span><span class="o">.</span><span class="n">delta_Ehh</span><span class="p">,</span> <span class="n">strain_parameters</span><span class="o">.</span><span class="n">delta_Elh</span><span class="p">)</span>

        <span class="c1"># Calculating this properly for QWs is done in the &quot;RecalculateDensityOfStates&quot; routine      </span>
        <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s2">&quot;Ncc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">*</span> <span class="n">me</span> <span class="o">*</span> <span class="n">kb</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span> <span class="o">/</span> <span class="n">h</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mf">1.5</span>
        <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s2">&quot;Nvhh&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">*</span> <span class="n">mhh</span> <span class="o">*</span> <span class="n">kb</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span> <span class="o">/</span> <span class="n">h</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mf">1.5</span>
        <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s2">&quot;Nvlh&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">*</span> <span class="n">mlh</span> <span class="o">*</span> <span class="n">kb</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span> <span class="o">/</span> <span class="n">h</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mf">1.5</span></div>

        <span class="c1"># ------</span>

<div class="viewcode-block" id="QWunit.RecalculateBandEdges"><a class="viewcode-back" href="../../../PDD/QWunit.html#solcore.poisson_drift_diffusion.QWunit.QWunit.RecalculateBandEdges">[docs]</a>    <span class="k">def</span> <span class="nf">RecalculateBandEdges</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">SR</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The effective bandgap and effective affinity of each layer depends on the energy level, e.g.: the minimum energy for electrons is not the band edge of the conduction band, but the ground level. In this function we modify that creating an effective electron afinity and band gaps for all layers in the QW.</span>
<span class="sd">        # </span>
<span class="sd">        # For the barriers, the electron afinity and band gap is the same than in bulk, modified by the kp calculation, if necesary.&quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">RecalculateKP</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>

            <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s2">&quot;elevels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s2">&quot;hhlevels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s2">&quot;lhlevels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s2">&quot;eff_band_gap&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">band_gap</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s2">&quot;eff_electron_affinity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">electron_affinity</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="ow">is</span> <span class="s2">&quot;well&quot;</span><span class="p">:</span>

                <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">elevels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elevels</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">hhlevels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hhlevels</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">lhlevels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhlevels</span>

                <span class="c1"># We create an effective bandgap and electron afinitiy to account for the confinement energies of electrons and holes</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">eff_band_gap</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">eff_band_gap</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">elevels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">q</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">eff_electron_affinity</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">eff_electron_affinity</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">elevels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">q</span>

                <span class="c1"># if ( max(schrodinger_result[&quot;potentials&quot;][&quot;Vhh&quot;]) &gt; max(schrodinger_result[&quot;potentials&quot;][&quot;Vlh&quot;]) ): </span>
                <span class="k">if</span> <span class="p">(</span><span class="n">SR</span><span class="p">[</span><span class="s2">&quot;E&quot;</span><span class="p">][</span><span class="s2">&quot;Ehh&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">SR</span><span class="p">[</span><span class="s2">&quot;E&quot;</span><span class="p">][</span><span class="s2">&quot;Elh&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">eff_band_gap</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">eff_band_gap</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">hhlevels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">q</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">eff_band_gap</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">eff_band_gap</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhlevels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">q</span>

                <span class="n">well_eff_electron_afinity</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">eff_electron_affinity</span>
                <span class="n">well_eff_band_gap</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">eff_band_gap</span>

        <span class="c1"># We re-run the loop to correct the electron affinity of the interlayers    </span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="ow">is</span> <span class="s2">&quot;interlayer&quot;</span><span class="p">:</span>
                <span class="c1"># The effective electron afinity is whatever is lower, its own afinity or the effective affinity of the well</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">eff_electron_affinity</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">eff_electron_affinity</span><span class="p">,</span> <span class="n">well_eff_electron_afinity</span><span class="p">)</span>
                <span class="c1"># The bandgap is corrected so the valence band in the interlayer is always equal or lower than in the QW</span>
                <span class="n">gap_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">well_eff_electron_afinity</span> <span class="o">+</span> <span class="n">well_eff_band_gap</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">eff_electron_affinity</span> <span class="o">+</span> <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">eff_band_gap</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">gap_offset</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">eff_band_gap</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">eff_band_gap</span> <span class="o">+</span> <span class="n">gap_offset</span></div>

    <span class="c1"># ------</span>
<div class="viewcode-block" id="QWunit.RecalculateDensityOfStates"><a class="viewcode-back" href="../../../PDD/QWunit.html#solcore.poisson_drift_diffusion.QWunit.QWunit.RecalculateDensityOfStates">[docs]</a>    <span class="k">def</span> <span class="nf">RecalculateDensityOfStates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Calculates the effective density of states for each layer in the QW. The general rule is:</span>
<span class="sd">        #   1- Barriers have the bulk density of states</span>
<span class="sd">        #   2- QW have ALL the density of states asociated with the confined states + bulk density of states above the barrier</span>
<span class="sd">        #   3- Interlayers have only the bulk density of states above the barrier</span>
<span class="sd">        #</span>
<span class="sd">        # This simplification is similar to that in J. Nelson, M. Paxman, K. W. J. Barnham, J. S. Roberts, and C. Button, “Steady-state carrier escape from single quantum wells,” IEEE J. Quantum Electron., vol. 29, no. 6, pp. 1460–1468, 1993.</span>
<span class="sd">        #</span>
<span class="sd">        # From a physical porint of view, it can certainly be done much better&quot;&quot;&quot;</span>

        <span class="c1"># We use the average barrier electron afinity (considering only the barriers at the ends) as the electron afinity of the barrier</span>
        <span class="n">Xb</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">electron_affinity</span> <span class="o">+</span> <span class="bp">self</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">electron_affinity</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">Egb</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">band_gap</span> <span class="o">+</span> <span class="bp">self</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">band_gap</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

        <span class="n">b</span> <span class="o">=</span> <span class="n">q</span> <span class="o">/</span> <span class="p">(</span><span class="n">kb</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)):</span>
            <span class="n">Ncc</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">Ncc</span>
            <span class="n">Nvhh</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">Nvhh</span>
            <span class="n">Nvlh</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">Nvlh</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="ow">is</span> <span class="s2">&quot;barrier&quot;</span><span class="p">:</span>
                <span class="c1"># Barriers have the bulk density of states</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s2">&quot;Nc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ncc</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s2">&quot;Nv&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Nvhh</span> <span class="o">+</span> <span class="n">Nvlh</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="ow">is</span> <span class="s2">&quot;interlayer&quot;</span><span class="p">:</span>
                <span class="c1"># For electrons  -------------------------------------------------------------</span>
                <span class="n">Vconf</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">electron_affinity</span> <span class="o">-</span> <span class="n">Xb</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s2">&quot;Nc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ncc</span> <span class="o">*</span> <span class="n">erfc</span><span class="p">((</span><span class="n">b</span> <span class="o">*</span> <span class="n">Vconf</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">)</span>

                <span class="c1"># For holes ------------------------------------------------------------------</span>
                <span class="n">Vconf</span> <span class="o">=</span> <span class="n">Xb</span> <span class="o">+</span> <span class="n">Egb</span> <span class="o">-</span> <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">electron_affinity</span> <span class="o">-</span> <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">band_gap</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s2">&quot;Nv&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Nvhh</span> <span class="o">+</span> <span class="n">Nvlh</span><span class="p">)</span> <span class="o">*</span> <span class="n">erfc</span><span class="p">((</span><span class="n">b</span> <span class="o">*</span> <span class="n">Vconf</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># For electrons  -------------------------------------------------------------</span>

                <span class="c1">#   1- Contribution from bulk:</span>
                <span class="n">Vconf</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">electron_affinity</span> <span class="o">-</span> <span class="n">Xb</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s2">&quot;Nc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ncc</span> <span class="o">*</span> <span class="n">erfc</span><span class="p">((</span><span class="n">b</span> <span class="o">*</span> <span class="n">Vconf</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">)</span>

                <span class="c1">#   2- Contribution from confined levels</span>
                <span class="n">Nqw</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">eLevel</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">elevels</span><span class="p">:</span>
                    <span class="n">Nqw</span> <span class="o">=</span> <span class="n">Nqw</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">b</span> <span class="o">*</span> <span class="n">eLevel</span><span class="p">)</span>

                <span class="n">Nqw</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">/</span> <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">width</span> <span class="o">*</span> <span class="p">(</span><span class="n">Ncc</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">/</span> <span class="mf">3.</span><span class="p">)</span> <span class="o">*</span> <span class="n">Nqw</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">Nc</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">Nc</span> <span class="o">+</span> <span class="n">Nqw</span>

                <span class="c1"># For holes ------------------------------------------------------------------</span>

                <span class="c1">#   1- Contribution from bulk:</span>
                <span class="n">Vconf</span> <span class="o">=</span> <span class="n">Xb</span> <span class="o">+</span> <span class="n">Egb</span> <span class="o">-</span> <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">electron_affinity</span> <span class="o">-</span> <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">band_gap</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s2">&quot;Nv&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Nvhh</span> <span class="o">+</span> <span class="n">Nvlh</span><span class="p">)</span> <span class="o">*</span> <span class="n">erfc</span><span class="p">((</span><span class="n">b</span> <span class="o">*</span> <span class="n">Vconf</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">)</span>

                <span class="c1">#   2- Contribution from heavy holes confined levels</span>
                <span class="n">Nqw</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">hhLevel</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">hhlevels</span><span class="p">:</span>
                    <span class="n">Nqw</span> <span class="o">=</span> <span class="n">Nqw</span> <span class="o">+</span> <span class="p">(</span><span class="n">Nvhh</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">/</span> <span class="mf">3.</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">b</span> <span class="o">*</span> <span class="n">hhLevel</span><span class="p">)</span>

                    <span class="c1">#   3- Contribution from light holes confined levels</span>
                <span class="k">for</span> <span class="n">lhLevel</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">lhlevels</span><span class="p">:</span>
                    <span class="n">Nqw</span> <span class="o">=</span> <span class="n">Nqw</span> <span class="o">+</span> <span class="p">(</span><span class="n">Nvlh</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">/</span> <span class="mf">3.</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">b</span> <span class="o">*</span> <span class="n">lhLevel</span><span class="p">)</span>

                <span class="n">Nqw</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">/</span> <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">width</span> <span class="o">*</span> <span class="n">Nqw</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">Nv</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">Nv</span> <span class="o">+</span> <span class="n">Nqw</span></div>

    <span class="c1"># ------</span>
<div class="viewcode-block" id="QWunit.CalculateAbsorption"><a class="viewcode-back" href="../../../PDD/QWunit.html#solcore.poisson_drift_diffusion.QWunit.QWunit.CalculateAbsorption">[docs]</a>    <span class="k">def</span> <span class="nf">CalculateAbsorption</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">use_Adachi</span><span class="p">,</span> <span class="n">SR</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; If required, this function calculates the absorption of the QW, putting together the absorption of the confined levels and the absorption of the bulk. As with the density of states, the rules are:</span>
<span class="sd">        # </span>
<span class="sd">        #   1- Barriers have the bulk absorption</span>
<span class="sd">        #   2- Interlayers have the bulk absorption from the barrier energy and zero below that</span>
<span class="sd">        #   3- Wells have the absorption of the confined levels below the barrier energy and of the bulk above it. The calculation is similar to: C. I. Cabrera, J. C. Rimada, J. P. Connolly, and L. Hernandez, “Modelling of GaAsP/InGaAs/GaAs strain-balanced multiple-quantum well solar cells,” J. Appl. Phys., vol. 113, no. 2, p. 024512, Jan. 2013.&quot;&quot;&quot;</span>

        <span class="n">edge</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">band_gap</span> <span class="o">+</span> <span class="bp">self</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">band_gap</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">q</span>
        <span class="n">edge_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wl</span> <span class="o">-</span> <span class="mf">1240e-9</span> <span class="o">/</span> <span class="n">edge</span><span class="p">)</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>

        <span class="c1"># We set the energy levels and absorption coefficient of each layer of the QW unit.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">absorption</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">wl</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">use_Adachi</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">absorption</span> <span class="o">=</span> \
                        <span class="n">adachi_alpha</span><span class="o">.</span><span class="n">create_adachi_alpha</span><span class="p">(</span><span class="n">SolcoreMaterialToStr</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">material</span><span class="p">),</span> <span class="n">T</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                                                         <span class="n">wl</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wl</span><span class="p">)[</span>
                            <span class="mi">3</span><span class="p">]</span>  <span class="c1"># 0 = Energy, 1 = n, 2 = k, 3 = Absorption</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">absorption</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">alpha</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wl</span><span class="p">)</span>
                    <span class="c1"># self[index].material.absorption[self.wl&gt;1240e-9/sc.asUnit(self[index].material.band_gap, &#39;eV&#39; )] = 0</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">absorption</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">alpha</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wl</span><span class="p">)</span>
                    <span class="c1"># self[index].material.absorption[self.wl&gt;1240e-9/sc.asUnit(self[index].material.band_gap, &#39;eV&#39; )] = 0</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: Using Adachi calculation to estimate the absorption coefficient of layer: &quot;</span><span class="p">,</span>
                          <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
                    <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">absorption</span> <span class="o">=</span> \
                        <span class="n">adachi_alpha</span><span class="o">.</span><span class="n">create_adachi_alpha</span><span class="p">(</span><span class="n">SolcoreMaterialToStr</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">material</span><span class="p">),</span> <span class="n">T</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                                                         <span class="n">wl</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wl</span><span class="p">)[</span>
                            <span class="mi">3</span><span class="p">]</span>  <span class="c1"># 0 = Energy, 1 = n, 2 = k, 3 = Absorption</span>

            <span class="c1"># self[index].material.absorption[ edge_index: ] = 0</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="ow">is</span> <span class="s2">&quot;well&quot;</span><span class="p">:</span>

                <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">absorption</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">absorption</span> <span class="o">-</span> <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">absorption</span><span class="p">[</span>
                    <span class="n">edge_index</span><span class="p">]</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">absorption</span><span class="p">[</span><span class="n">edge_index</span><span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">absorption</span><span class="p">[</span><span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">absorption</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">absorption</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">absorption</span> <span class="o">+</span> <span class="n">SR</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="p">[</span>
                    <span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">QW_width</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="ow">is</span> <span class="s2">&quot;interlayer&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">absorption</span><span class="p">[</span><span class="n">edge_index</span><span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">absorption</span><span class="p">[</span><span class="n">edge_index</span><span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">absorption</span> <span class="o">+=</span> <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">absorption</span></div>

    <span class="c1"># ------</span>
<div class="viewcode-block" id="QWunit.solve"><a class="viewcode-back" href="../../../PDD/QWunit.html#solcore.poisson_drift_diffusion.QWunit.QWunit.solve">[docs]</a>    <span class="k">def</span> <span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Efield</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">WLsteps</span><span class="o">=</span><span class="p">(</span><span class="mf">300e-9</span><span class="p">,</span> <span class="mf">1100e-9</span><span class="p">,</span> <span class="mi">201</span><span class="p">),</span> <span class="n">wavelengths</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">periodic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">filter_strength</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
              <span class="n">blur</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">blurmode</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;kp8x8_bulk&#39;</span><span class="p">,</span> <span class="n">use_Adachi</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">calculate_absorption</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">alpha_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="mi">293</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Solves the structure, calculating the energy levels, the absorption, etc. &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">T</span> <span class="o">=</span> <span class="n">T</span>

        <span class="k">if</span> <span class="n">calculate_absorption</span><span class="p">:</span>
            <span class="c1"># If we want the absorption but have not provided enough data for that, we make up some default values</span>
            <span class="k">if</span> <span class="n">alpha_params</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">wavelengths</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">wl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">*</span><span class="n">WLsteps</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">wl</span> <span class="o">=</span> <span class="n">wavelengths</span>

                <span class="n">E</span> <span class="o">=</span> <span class="mi">1240</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wl</span> <span class="o">*</span> <span class="mf">1e9</span><span class="p">)</span> <span class="o">*</span> <span class="n">q</span>

                <span class="n">alpha_params</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;well_width&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">QW_width</span><span class="p">,</span>
                    <span class="s2">&quot;theta&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="s2">&quot;eps&quot;</span><span class="p">:</span> <span class="mf">12.9</span> <span class="o">*</span> <span class="n">vacuum_permittivity</span><span class="p">,</span>
                    <span class="s2">&quot;espace&quot;</span><span class="p">:</span> <span class="n">E</span><span class="p">,</span>
                    <span class="s2">&quot;hwhm&quot;</span><span class="p">:</span> <span class="n">si</span><span class="p">(</span><span class="s2">&quot;4meV&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;dimensionality&quot;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span>
                    <span class="c1"># &quot;line_shape&quot;: &quot;Gauss&quot;</span>
                <span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wl</span> <span class="o">=</span> <span class="mi">1240</span> <span class="o">/</span> <span class="p">(</span><span class="n">alpha_params</span><span class="p">[</span><span class="s2">&quot;espace&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e-9</span><span class="p">)</span> <span class="o">*</span> <span class="n">q</span>

        <span class="n">SR</span><span class="p">,</span> <span class="n">bands</span> <span class="o">=</span> <span class="n">schrodinger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">periodic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">calculate_absorption</span><span class="o">=</span><span class="n">calculate_absorption</span><span class="p">,</span>
                                <span class="n">Efield</span><span class="o">=</span><span class="n">Efield</span><span class="p">,</span>
                                <span class="n">blur</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">blurmode</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">alpha_params</span><span class="o">=</span><span class="n">alpha_params</span><span class="p">,</span> <span class="n">filter_strength</span><span class="o">=</span><span class="n">filter_strength</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s2">&quot;elevels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">SR</span><span class="p">[</span><span class="s2">&quot;E&quot;</span><span class="p">][</span><span class="s2">&quot;Ee&quot;</span><span class="p">][:]</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">SR</span><span class="p">[</span><span class="s2">&quot;potentials&quot;</span><span class="p">][</span><span class="s2">&quot;Ve&quot;</span><span class="p">]))</span> <span class="o">/</span> <span class="n">q</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s2">&quot;hhlevels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">SR</span><span class="p">[</span><span class="s2">&quot;potentials&quot;</span><span class="p">][</span><span class="s2">&quot;Vhh&quot;</span><span class="p">])</span> <span class="o">-</span> <span class="n">SR</span><span class="p">[</span><span class="s2">&quot;E&quot;</span><span class="p">][</span><span class="s2">&quot;Ehh&quot;</span><span class="p">][:])</span> <span class="o">/</span> <span class="n">q</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s2">&quot;lhlevels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">SR</span><span class="p">[</span><span class="s2">&quot;potentials&quot;</span><span class="p">][</span><span class="s2">&quot;Vlh&quot;</span><span class="p">])</span> <span class="o">-</span> <span class="n">SR</span><span class="p">[</span><span class="s2">&quot;E&quot;</span><span class="p">][</span><span class="s2">&quot;Elh&quot;</span><span class="p">][:])</span> <span class="o">/</span> <span class="n">q</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">RecalculateBandEdges</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">SR</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">RecalculateDensityOfStates</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">calculate_absorption</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">CalculateAbsorption</span><span class="p">(</span><span class="n">use_Adachi</span><span class="p">,</span> <span class="n">SR</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">SR</span></div></div>

        <span class="c1"># ------</span>


<span class="c1"># ------</span>
<div class="viewcode-block" id="SolcoreMaterialToStr"><a class="viewcode-back" href="../../../PDD/QWunit.html#solcore.poisson_drift_diffusion.QWunit.SolcoreMaterialToStr">[docs]</a><span class="k">def</span> <span class="nf">SolcoreMaterialToStr</span><span class="p">(</span><span class="n">material_input</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Translate a solcore material composition into a string that is what the Adachi calculator needs.&quot;&quot;&quot;</span>

    <span class="n">material_string</span> <span class="o">=</span> <span class="n">material_input</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;&lt;&gt;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
    <span class="n">material_name</span> <span class="o">=</span> <span class="n">material_string</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>
    <span class="n">composition</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;material&#39;</span><span class="p">:</span> <span class="n">material_name</span><span class="p">}</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">material_name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">material_composition</span> <span class="o">=</span> <span class="n">material_string</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">comp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">material_composition</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">material_name</span><span class="p">:</span>
                <span class="n">composition</span><span class="p">[</span><span class="s1">&#39;element&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">material_composition</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">composition</span><span class="p">[</span><span class="s1">&#39;fraction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">material_composition</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>

    <span class="n">output</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> {&#39;</span><span class="si">%s</span><span class="s2">&#39;:</span><span class="si">%s</span><span class="s2">}&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">composition</span><span class="p">[</span><span class="s1">&#39;material&#39;</span><span class="p">],</span> <span class="n">composition</span><span class="p">[</span><span class="s1">&#39;element&#39;</span><span class="p">],</span> <span class="n">composition</span><span class="p">[</span><span class="s1">&#39;fraction&#39;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">output</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">Solcore 5.0.2 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2018, Quantum Photovoltaics Group, Imperial College London.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.3.
    </div>
  </body>
</html>